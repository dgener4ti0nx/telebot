#!/bin/bash

## INIT__ 
TOKEN=$(<$HOME/.telebot/token)
USER=$(<$HOME/.telebot/users)


################### token or files not found
if [[ -z "$TOKEN" ]]; then
	echo -e "No bot TOKEN specified.\nPlease add bot API key to the token file"
	exit 1
fi
if [[ -z "$USER" ]]; then
	echo -e "No user values found.\nPlease add users to the users file using the following format:\n
	[user] [chatid]"
	exit 1
fi


################### Send
if [[ $1 == "-s" ]]; then
	if [ $2 == "$(echo $USER | grep $2 | awk '{print $1}')" ]; then
		CHATID="$(echo $USER | grep $2 | awk '{print $2}')"
	else
		echo "Sorry, user \"$2\" was not found."
		exit 1
	fi
	if [ ${#CHATID} != 9 ]; then
		echo "Sorry, user \"$2\" CHATID has a unusual lenght and is most likely incorrect."
		exit 1
	
	fi
	MESSAGE=${3:-$(</dev/stdin)} #takes message input from $3, in case it is not set (null value), takes message from standard input (eg.: an echo piped)
	curl -s -X POST https://api.telegram.org/bot$TOKEN/sendMessage -d chat_id=$CHATID -d text="$MESSAGE" -d parse_mode="markdown" > /dev/null
	echo -n "Sent to $2: "
	echo -e $MESSAGE
	exit 2
fi
